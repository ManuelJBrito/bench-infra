# SPEC LLVM Benchmark

This repository contains infrastructure to build and run **GVN-related benchmarks** using [SPEC CPU2017](https://www.spec.org/cpu2017/), [LLVM’s test-suite](https://llvm.org/docs/TestSuiteGuide.html), and custom GVN variants across multiple machines. It also includes previously collected results.

---

## Requirements

- [LLVM test-suite](https://llvm.org/docs/TestSuiteGuide.html)
- [llvm-lit](https://llvm.org/docs/CommandGuide/lit.html) (from an LLVM build or installable via `pip`)
- [SPEC CPU2017](https://www.spec.org/cpu2017/)

---

## Getting Started

```bash
# Clone this repository
git clone https://github.com/ManuelJBrito/bench-infra
cd bench-infra

# Get the LLVM test-suite
git clone https://github.com/llvm/llvm-test-suite.git test-suite

# Symlink your SPEC2017 installation
ln -s /full/path/to/cpu2017 test-suite/test-suite-externals/speccpu2017

# Generate scripts/common.sh (env setup)
# see -h for all options
chmod +x ./autogen.sh
./autogen.sh --cc /path/to/clang --lit /path/to/llvm-lit  
```

---

## Building SPEC Benchmarks

To compile SPEC benchmarks for a specific variant (e.g., `O2`), first define the variant:

```bash
echo '{"FLAGS" : "-O2"}' > variants/O2.json
```

Then build using:

```bash
chmod +x ./scripts/build_variant.sh
./scripts/build_variant.sh O2 test
```

- Use the `test` runtype first to validate the configuration.
- Once stable, use `ref` runtype for meaningful benchmarking.

---

## Running SPEC Benchmarks

After building a variant:

```bash
./scripts/run_variant.sh O2
```

This runs the tests `RUNS` number of times and outputs results in:

```
results/<machine-name>/O2/<timestamp>/result_run{i}.json
```

---

## Comparing Results

To merge and compare results, use the test-suite utility:

```bash
python3 test-suite/utils/compare.py result_run1.json result_run2.json ...
```

📝 *TODO*: Add helper scripts to automate merging and summarizing results.

---

## File Structure

```text
bench-infra/
├── autogen.sh                 # Top-level script to generate common.sh
├── builds/                    # Default build output directory (can be renamed)
│   ├── O2/
│   └── ...
├── results/                   # Benchmark outputs
│   ├── machine1/
│   │   ├── O2/
│   │   │   ├── <timestamp>/
│   │   │   │   ├── result_run1.json
│   │   │   │   └── ...
│   │   └── ...
│   └── machineN/
├── scripts/                   # Helper scripts
│   ├── build_variant.sh       # Build benchmarks for a variant
│   ├── run_variant.sh         # Run benchmarks and store results
│   └── common.sh              # Auto-generated by autogen.sh (env setup)
├── test-suite/                # LLVM test-suite (cloned)
│   └── test-suite-externals/
│       └── speccpu2017 -> /path/to/cpu2017
└── variants/                  # Benchmark variants (optimization configs)
    ├── O2.json
    ├── optFoo.json
    └── ...
```
